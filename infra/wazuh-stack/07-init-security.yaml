---
# Job para inicializar la seguridad de OpenSearch
# Este script ejecuta securityadmin.sh para configurar el usuario admin y los roles internos
apiVersion: batch/v1
kind: Job
metadata:
  name: wazuh-security-init
  namespace: wazuh
  labels:
    app: wazuh-security-init
spec:
  template:
    metadata:
      labels:
        app: wazuh-security-init
    spec:
      # Debe correr en el mismo nodo (lake) para acceso a la red/pods si fuera necesario,
      # aunque accede via Service ClusterIP, no es estricto, pero por consistencia:
      nodeSelector:
        kubernetes.io/hostname: lake
      
      restartPolicy: OnFailure
      
      containers:
        - name: security-admin
          image: wazuh/wazuh-indexer:4.14.1
          command:
            - /bin/bash
            - -c
            - |
              echo "Waiting for Wazuh Indexer to be ready..."
              # Esperar a que el puerto 9200 esté abierto
              until curl -sk https://wazuh-indexer:9200 > /dev/null; do
                echo "Indexer not ready yet, sleeping..."
                sleep 5
              done
              
              echo "Indexer is up. Initializing Security Plugin..."
              
              # Ejecutar securityadmin.sh
              # -cd: Directorio de configuración
              # -icl: Ignorar verificación de nombre de certificado en conexión
              # -nhnv: No usar hostname, no verificar nombre (común en k8s)
              # -cacert, -cert, -key: Credenciales TLS
              # -h: Host destino
              
              /usr/share/wazuh-indexer/bin/securityadmin.sh \
                -cd /usr/share/wazuh-indexer/plugins/opensearch-security/securityconfig/ \
                -icl \
                -nhnv \
                -cacert /usr/share/wazuh-indexer/certs/root-ca.pem \
                -cert /usr/share/wazuh-indexer/certs/admin.pem \
                -key /usr/share/wazuh-indexer/certs/admin-key.pem \
                -h wazuh-indexer
              
              if [ $? -eq 0 ]; then
                echo "Security initialized successfully!"
                exit 0
              else
                echo "Failed to initialize security!"
                exit 1
              fi
          
          volumeMounts:
            - name: certs-volume
              mountPath: /usr/share/wazuh-indexer/certs
              readOnly: true
            # Opcional: Montar config si necesitas ajustar policies personalizadas, 
            # pero las defaults suelen bastar para arranque inicial.
          
      volumes:
        - name: certs-volume
          persistentVolumeClaim:
            claimName: wazuh-certs