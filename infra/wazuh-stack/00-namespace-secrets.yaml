---
apiVersion: v1
kind: Namespace
metadata:
  name: wazuh
  labels:
    app.kubernetes.io/name: wazuh
    app.kubernetes.io/component: security
---
# Wazuh API and Indexer credentials
# IMPORTANT: Change these passwords before deploying!
apiVersion: v1
kind: Secret
metadata:
  name: wazuh-credentials
  namespace: wazuh
type: Opaque
stringData:
  # Wazuh API credentials (for manager)
  WAZUH_API_USER: "wazuh-wui"
  WAZUH_API_PASSWORD: "ZCloud-Wazuh-2026!"
  
  # Indexer (OpenSearch) credentials  
  INDEXER_USERNAME: "admin"
  INDEXER_PASSWORD: "ZCloud-Indexer-2026!"
  
  # Agent enrollment password
  WAZUH_AUTHD_PASS: "ZCloud-Agent-Enroll-2026!"
---
# Indexer internal certificates (self-signed for internal comms)
# In production, replace with proper certs
apiVersion: v1
kind: Secret
metadata:
  name: wazuh-indexer-certs
  namespace: wazuh
type: Opaque
data:
  # Placeholder - will be generated by init container
  # These are base64 encoded empty placeholders
  root-ca.pem: ""
  indexer.pem: ""
  indexer-key.pem: ""
  admin.pem: ""
  admin-key.pem: ""
---
# ConfigMap for certificate generation script
apiVersion: v1
kind: ConfigMap
metadata:
  name: wazuh-certs-generator
  namespace: wazuh
data:
  generate-certs.sh: |
    #!/bin/bash
    set -e
    
    CERTS_DIR="/certs"
    
    # Check if certs already exist
    if [ -f "$CERTS_DIR/root-ca.pem" ] && [ -s "$CERTS_DIR/root-ca.pem" ]; then
      echo "Certificates already exist, skipping generation"
      exit 0
    fi
    
    echo "Generating Wazuh indexer certificates..."
    
    # Generate Root CA
    openssl genrsa -out $CERTS_DIR/root-ca-key.pem 2048
    openssl req -new -x509 -sha256 -key $CERTS_DIR/root-ca-key.pem -out $CERTS_DIR/root-ca.pem -days 3650 \
      -subj "/C=ES/ST=Spain/L=Madrid/O=ZCloud/OU=Security/CN=Wazuh Root CA"
    
    # Generate Admin cert (for indexer management)
    openssl genrsa -out $CERTS_DIR/admin-key.pem 2048
    openssl req -new -key $CERTS_DIR/admin-key.pem -out $CERTS_DIR/admin.csr \
      -subj "/C=ES/ST=Spain/L=Madrid/O=ZCloud/OU=Security/CN=admin"
    openssl x509 -req -in $CERTS_DIR/admin.csr -CA $CERTS_DIR/root-ca.pem -CAkey $CERTS_DIR/root-ca-key.pem \
      -CAcreateserial -out $CERTS_DIR/admin.pem -days 3650 -sha256
    
    # Generate Indexer cert
    cat > $CERTS_DIR/indexer.ext << EOF
    authorityKeyIdentifier=keyid,issuer
    basicConstraints=CA:FALSE
    keyUsage = digitalSignature, nonRepudiation, keyEncipherment, dataEncipherment
    subjectAltName = @alt_names
    [alt_names]
    DNS.1 = wazuh-indexer
    DNS.2 = wazuh-indexer.wazuh.svc.cluster.local
    DNS.3 = localhost
    IP.1 = 127.0.0.1
    EOF
    
    openssl genrsa -out $CERTS_DIR/indexer-key.pem 2048
    openssl req -new -key $CERTS_DIR/indexer-key.pem -out $CERTS_DIR/indexer.csr \
      -subj "/C=ES/ST=Spain/L=Madrid/O=ZCloud/OU=Security/CN=wazuh-indexer"
    openssl x509 -req -in $CERTS_DIR/indexer.csr -CA $CERTS_DIR/root-ca.pem -CAkey $CERTS_DIR/root-ca-key.pem \
      -CAcreateserial -out $CERTS_DIR/indexer.pem -days 3650 -sha256 -extfile $CERTS_DIR/indexer.ext
    
    # Generate Manager cert (for filebeat -> indexer)
    cat > $CERTS_DIR/manager.ext << EOF
    authorityKeyIdentifier=keyid,issuer
    basicConstraints=CA:FALSE
    keyUsage = digitalSignature, nonRepudiation, keyEncipherment, dataEncipherment
    subjectAltName = @alt_names
    [alt_names]
    DNS.1 = wazuh-manager
    DNS.2 = wazuh-manager.wazuh.svc.cluster.local
    DNS.3 = localhost
    IP.1 = 127.0.0.1
    EOF
    
    openssl genrsa -out $CERTS_DIR/manager-key.pem 2048
    openssl req -new -key $CERTS_DIR/manager-key.pem -out $CERTS_DIR/manager.csr \
      -subj "/C=ES/ST=Spain/L=Madrid/O=ZCloud/OU=Security/CN=wazuh-manager"
    openssl x509 -req -in $CERTS_DIR/manager.csr -CA $CERTS_DIR/root-ca.pem -CAkey $CERTS_DIR/root-ca-key.pem \
      -CAcreateserial -out $CERTS_DIR/manager.pem -days 3650 -sha256 -extfile $CERTS_DIR/manager.ext
    
    # Generate Dashboard cert
    cat > $CERTS_DIR/dashboard.ext << EOF
    authorityKeyIdentifier=keyid,issuer
    basicConstraints=CA:FALSE
    keyUsage = digitalSignature, nonRepudiation, keyEncipherment, dataEncipherment
    subjectAltName = @alt_names
    [alt_names]
    DNS.1 = wazuh-dashboard
    DNS.2 = wazuh-dashboard.wazuh.svc.cluster.local
    DNS.3 = wazuh.zyrak.cloud
    DNS.4 = localhost
    IP.1 = 127.0.0.1
    EOF
    
    openssl genrsa -out $CERTS_DIR/dashboard-key.pem 2048
    openssl req -new -key $CERTS_DIR/dashboard-key.pem -out $CERTS_DIR/dashboard.csr \
      -subj "/C=ES/ST=Spain/L=Madrid/O=ZCloud/OU=Security/CN=wazuh-dashboard"
    openssl x509 -req -in $CERTS_DIR/dashboard.csr -CA $CERTS_DIR/root-ca.pem -CAkey $CERTS_DIR/root-ca-key.pem \
      -CAcreateserial -out $CERTS_DIR/dashboard.pem -days 3650 -sha256 -extfile $CERTS_DIR/dashboard.ext
    
    # Set permissions
    chmod 644 $CERTS_DIR/*.pem
    chmod 600 $CERTS_DIR/*-key.pem
    
    echo "Certificates generated successfully!"
    ls -la $CERTS_DIR/